"use strict";
/* IMPORT */
var css_simple_parser_1 = require("css-simple-parser");
var resolve_1 = require("./resolve");
/* CSS FLATTEN */
function flatten(css) {
    /* PARSING */
    var AST = css_simple_parser_1.default.parse(css);
    /* RESOLVING SELECTORS */
    css_simple_parser_1.default.traverse(AST, function (node) {
        var selector = node.selector, parent = node.parent;
        var selectors = selector.trim().split(/\s*,\s*/g); // Splitting and cleaning up
        if (!parent['selector']) { // Top-level node
            if (selector.indexOf('&') >= 0)
                throw new Error('Top-level ampersand placeholders are invalid');
        }
        else {
            selectors = resolve_1.default.selectors(selectors, parent['selectors']);
            node.selector = selectors.join(',');
        }
        node['selectors'] = selectors;
    });
    /* FLATTENING */
    var nodes = [];
    css_simple_parser_1.default.traverse(AST, function (node) {
        if (!/\S/.test(node.body))
            return; // Ignoring empty blocks, nothing to output
        nodes.push(node);
    });
    AST.children = nodes;
    /* WIDOWING */
    var empty = [];
    for (var i = 0, l = nodes.length; i < l; i++) {
        nodes[i].children = empty;
    }
    /* STRINGIFYING */
    return css_simple_parser_1.default.stringify(AST);
}
/* EXPORT */
module.exports = flatten;
module.exports.default = flatten;
Object.defineProperty(module.exports, "__esModule", { value: true });
